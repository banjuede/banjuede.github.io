# 资源配置
> 42.159.28.179 datacanvasbase0.cloudapp.cn aps-base0
> 139.217.25.21 datacanvasbase1.cloudapp.cn eds-base1
> 139.217.27.28 datacanvasbase2.cloudapp.cn eds-base2
> 139.217.17.241 datacanvasbase3.cloudapp.cn eds-base3
> 139.217.20.225 datacanvasbase4.cloudapp.cn eds-base4
> 139.217.19.182 datacanvasbase6.cloudapp.cn eds-base5
> 开放的端口是：5050-5060
> spec server host: aps-base0  port: 5051

# 模块封装
>```
1. screwjack init basic --name="Honeywell_fault_analysis_pre" --description="Honeywell_fault_analysis_system_pre"
2. screwjack init basic --name="Honeywell_fault_analysis_rest" --description="Honeywell_fault_analysis_system_rest"  
>```

---
> docker build -t pretest ./
> ssh lumq@repo.datacanvas.io  123456
> sudo docker run -it --rm --name mktest resttest  
> apt-get update
> apt-get install python-matplotlib



# 故障测试可视化

---
## redash 关联表

---
### 报警级别表 alarmlevel
表结构：
>```
CREATE TABLE alarmlevel (
  alarmlevel CHARACTER VARYING NOT NULL,
  levelname CHARACTER VARYING NOT NULL
);
>```

表数据：
>```]
INSERT INTO alarmlevel (alarmlevel, levelname) VALUES ('0', '一般报警');
INSERT INTO alarmlevel (alarmlevel, levelname) VALUES ('1', '较重报警');
INSERT INTO alarmlevel (alarmlevel, levelname) VALUES ('2', '严重报警');
>```


### 报警类型表 alarmtype
表结构：
>```
CREATE TABLE alarmtype (
  alarmtype CHARACTER VARYING NOT NULL,
  typename CHARACTER VARYING NOT NULL
);
>```

表数据：
>```
INSERT INTO alarmtype (alarmtype, typename) VALUES ('0', '设备/故障报警');
INSERT INTO alarmtype (alarmtype, typename) VALUES ('1', '运行报警');
>```


### 故障类型表 faulttype
表结构：
>```
CREATE TABLE faulttype (
  faulttype CHARACTER VARYING NOT NULL,
  typename CHARACTER VARYING NOT NULL
);
>```

表数据：
>```
INSERT INTO faulttype (faulttype, typename) VALUES ('1', '暖通空调');
INSERT INTO faulttype (faulttype, typename) VALUES ('2', '给水排水');
INSERT INTO faulttype (faulttype, typename) VALUES ('3', '变配电');
INSERT INTO faulttype (faulttype, typename) VALUES ('4', '公共照明');
INSERT INTO faulttype (faulttype, typename) VALUES ('5', '夜景照明');
INSERT INTO faulttype (faulttype, typename) VALUES ('6', '电梯运行');
INSERT INTO faulttype (faulttype, typename) VALUES ('9', '视频监控');
INSERT INTO faulttype (faulttype, typename) VALUES ('10', '防盗报警');
INSERT INTO faulttype (faulttype, typename) VALUES ('11', '门禁管理');
INSERT INTO faulttype (faulttype, typename) VALUES ('12', '能耗计量');
>```

---
## 分析结果可视化

--- 
### 故障类型统计
>```
SELECT count(*),b.typename FROM alarmhistory a join faulttype b on a.subsystemid = b.faulttype group by b.typename;
>```

### 告警类型统计
>```
SELECT count(*),b.typename FROM alarmhistory a join alarmtype b on a.alarmtype = b.alarmtype group by b.typename;
>```

### 告警级别统计
>```
SELECT count(a.*),b.levelname FROM alarmhistory a join alarmlevel b on a.alarmlevel = b.alarmlevel group by b.levelname;
>```

### 高频故障类型

#### 高频故障类型top_3
>```
SELECT DISTINCT a.subsystemid,count(*) AS count,b.typename FROM alarmhistory a join faulttype b on a.subsystemid = b.faulttype GROUP BY a.subsystemid,b.typename ORDER BY count DESC LIMIT 3;
>```

#### SubsystemID2
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where subsystemid = 2 GROUP BY datetime ORDER BY datetime DESC;
>```

#### SubsystemID4
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where subsystemid = 4 GROUP BY datetime ORDER BY datetime DESC;
>```

#### SubsystemID5
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where subsystemid = 5 GROUP BY datetime ORDER BY datetime DESC;
>```

### 高频故障节点

#### 高频故障节点top3
>```
SELECT DISTINCT a.pointID,count(*) AS count,b.displayname FROM alarmhistory a join pointinformation b on a.pointid = b.entityid where a.pointid != 0 GROUP BY a.pointID,b.displayname ORDER BY count DESC LIMIT 3;
>```

#### PointID0
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where pointID = 0 GROUP BY datetime ORDER BY datetime DESC;
>```

#### PointID19245
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where pointID = 19245 GROUP BY datetime ORDER BY datetime DESC;
>```

#### PointID29544
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where pointID = 29544 GROUP BY datetime ORDER BY datetime DESC;
>```

### 高频故障设备

#### 高频故障设备top3
>```
SELECT DISTINCT a.equipmentid,count(a.*) AS count,b.displayname FROM alarmhistory a join equipments b on a.equipmentid = b.entityid GROUP BY a.equipmentid,b.displayname ORDER BY count DESC LIMIT 3;

>```
#### EquipmentID0
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where equipmentid = 0 GROUP BY datetime ORDER BY datetime DESC;
>```

#### EquipmentID1572
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where equipmentid = 1572 GROUP BY datetime ORDER BY datetime DESC;
>```

#### EquipmentID3457
>```
SELECT DISTINCT count(*),to_date(alarmdatetime,'YYYY-MM-DD') as datetime FROM alarmhistory where equipmentid = 3457 GROUP BY datetime ORDER BY datetime DESC;
>```